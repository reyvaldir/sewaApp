generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Category {
  id          String    @id @default(cuid())
  name        String    @unique
  products    Product[]
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@map("categories")
}

model Product {
  id                 String          @id @default(cuid())
  name               String
  pricePerDay        Decimal         @db.Decimal(10, 2)
  replacementCost    Decimal         @map("replacement_cost") @db.Decimal(10, 2)
  cleaningDaysBuffer Int             @default(1) @map("cleaning_days_buffer")
  categoryId         String
  category           Category        @relation(fields: [categoryId], references: [id])
  inventoryUnits     InventoryUnit[]
  bundleItems        BundleItem[]
  createdAt          DateTime        @default(now())
  updatedAt          DateTime        @updatedAt

  @@map("products")
}

model InventoryUnit {
  id          String       @id @default(cuid())
  barcode     String       @unique
  status      UnitStatus   @default(AVAILABLE)
  productId   String
  product     Product      @relation(fields: [productId], references: [id])
  rentalItems RentalItem[]
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt

  @@map("inventory_units")
}

enum UnitStatus {
  AVAILABLE
  RENTED
  LAUNDRY
  DAMAGED
}

model Bundle {
  id          String       @id @default(cuid())
  name        String
  pricePerDay Decimal      @db.Decimal(10, 2)
  items       BundleItem[]
  rentals     RentalItem[]
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt

  @@map("bundles")
}

model BundleItem {
  id        String  @id @default(cuid())
  bundleId  String
  bundle    Bundle  @relation(fields: [bundleId], references: [id])
  productId String
  product   Product @relation(fields: [productId], references: [id])
  quantity  Int     @default(1)

  @@unique([bundleId, productId])
  @@map("bundle_items")
}

model Customer {
  id           String   @id @default(cuid())
  name         String
  nik          String   @unique
  phone        String
  ktpPhotoPath String?  @map("ktp_photo_path")
  rentals      Rental[]
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@map("customers")
}

model Rental {
  id         String       @id @default(cuid())
  customerId String
  customer   Customer     @relation(fields: [customerId], references: [id])
  startDate  DateTime
  endDate    DateTime
  totalPrice Decimal      @db.Decimal(10, 2)
  penalty    Decimal      @default(0) @db.Decimal(10, 2)
  items      RentalItem[]
  createdAt  DateTime     @default(now())
  updatedAt  DateTime     @updatedAt

  @@map("rentals")
}

model RentalItem {
  id              String         @id @default(cuid())
  rentalId        String
  rental          Rental         @relation(fields: [rentalId], references: [id])
  
  // Either an individual product unit or part of a bundle
  inventoryUnitId String
  inventoryUnit   InventoryUnit  @relation(fields: [inventoryUnitId], references: [id])
  
  // If it was rented as part of a bundle, log it here
  bundleId        String?
  bundle          Bundle?        @relation(fields: [bundleId], references: [id])
  
  price           Decimal        @db.Decimal(10, 2)

  @@map("rental_items")
}
